
<div class="min-h-screen bg-[#020205] text-white p-4 font-sans flex flex-col">
  
  <!-- This is a simplified header for the new layout -->
  <header class="flex-shrink-0 flex items-center justify-between max-w-[1400px] w-full mx-auto mb-4 px-2">
      <div class="flex items-center gap-3">
        <h1 class="text-xl font-black tracking-widest text-white">PRISMA <span class="text-purple-500 prisma-text-glow">AI</span></h1>
      </div>
       <!-- Mode Switcher -->
       <div class="flex items-center gap-1 p-1 rounded-lg bg-black/40 border border-purple-500/20">
        <button 
          (click)="setMode('live')"
          class="px-3 py-1 text-xs font-bold rounded-md transition-colors"
          [class]="mode() === 'live' ? 'bg-purple-600/50 text-purple-300' : 'text-gray-400 hover:bg-white/5'">
          LIVE
        </button>
        <button 
          (click)="setMode('upload')"
          class="px-3 py-1 text-xs font-bold rounded-md transition-colors"
          [class]="mode() === 'upload' ? 'bg-purple-600/50 text-purple-300' : 'text-gray-400 hover:bg-white/5'">
          UPLOAD
        </button>
      </div>
  </header>

  <main class="flex-grow max-w-[1400px] w-full mx-auto grid grid-cols-12 gap-6 h-[85vh]">
    
    <!-- COLUNA ESQUERDA: Market Intelligence & History -->
    <aside class="col-span-12 lg:col-span-3 flex flex-col gap-4">
        <!-- Market Intelligence -->
        <div class="bg-black/40 border border-purple-500/20 rounded-3xl p-6 shadow-[0_0_20px_rgba(168,85,247,0.1)]">
            <h2 class="text-purple-400 font-bold text-xs mb-6 uppercase tracking-widest">Market Intelligence</h2>
            <div class="space-y-6">
                <div>
                    <p class="text-[10px] text-gray-500 uppercase">Ativo Lido</p>
                    <p class="text-xl font-black text-white truncate">{{ analysisResult()?.asset || '---' }}</p>
                </div>
                <div class="p-4 bg-purple-600/10 rounded-2xl border border-purple-500/20">
                    <p class="text-[10px] text-purple-300 uppercase">Confidence Score</p>
                    <p class="text-2xl font-black text-purple-500">{{ analysisResult()?.assertividade || '--%' }}</p>
                </div>
            </div>
        </div>

        <!-- History Panel -->
        <div class="bg-black/40 border border-purple-500/20 rounded-3xl p-5 flex-1 flex flex-col overflow-hidden shadow-[0_0_20px_rgba(168,85,247,0.1)]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xs font-bold text-purple-400 flex items-center gap-2 uppercase">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                    Sinais Recentes
                </h3>
                @if(history().length > 0) {
                    <button (click)="clearHistory()" class="text-gray-500 hover:text-red-400 text-[10px] uppercase font-bold transition-colors">Limpar</button>
                }
            </div>
            <div class="flex-1 overflow-y-auto -mr-2 pr-2">
                <app-history-panel 
                    [history]="history()"
                    (markWin)="markAsWin($event)"
                    (markLoss)="markAsLoss($event)"
                />
            </div>
        </div>
    </aside>

    <!-- CENTRO: VISOR DO GRÃFICO (6 colunas) -->
    <main class="col-span-12 lg:col-span-6 relative rounded-3xl border-2 border-purple-500/30 overflow-hidden bg-black shadow-[0_0_40px_rgba(168,85,247,0.2)]">
        @if(isCapturing()) { <div class="prisma-scan-line"></div> }

        <video #videoElement autoPlay muted playsInline class="w-full h-full object-contain"></video>
        <canvas #canvasElement class="hidden"></canvas>

        @if (!isCapturing() && mode() === 'live') {
          <div class="absolute inset-0 flex flex-col items-center justify-center text-center p-4">
             <p class="mt-4 text-purple-400/50">Sensor Desconectado</p>
          </div>
        }

        @if (mode() === 'upload') {
            @if (uploadedImage()) {
                <img [src]="uploadedImage()" alt="Chart preview" class="absolute inset-0 rounded-3xl w-full h-full object-contain">
            } @else {
                <div 
                    (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)" (drop)="onDrop($event)"
                    class="absolute inset-0 flex flex-col items-center justify-center text-center p-4 border-2 border-dashed rounded-3xl transition-colors"
                    [class.border-purple-500]="isDragging()" [class.border-transparent]="!isDragging()">
                    <p class="text-sm text-slate-400">Arraste uma imagem aqui ou 
                        <label for="file-upload" class="cursor-pointer font-semibold text-purple-400 hover:text-purple-300">
                        selecione
                        <input id="file-upload" type="file" class="sr-only" (change)="onFileSelected($event)" accept="image/*">
                        </label>
                    </p>
                </div>
            }
        }
        
        <div class="absolute bottom-6 left-6 right-6 flex items-center justify-between">
            <div class="bg-black/80 backdrop-blur-xl border border-purple-500/40 p-3 rounded-2xl">
                 @if (isLoading()) {
                    <p class="text-xs text-purple-400 font-bold animate-pulse">ANALISANDO...</p>
                 } @else if (isCapturing()) {
                    <p class="text-xs text-purple-400 font-bold">PRISMA IA MONITORING...</p>
                 } @else if (analysisResult(); as result) {
                    <p class="text-xs text-white font-bold">{{result.reason}}</p>
                 } @else {
                    <p class="text-xs text-gray-500 font-bold">PRISMA IA INATIVO</p>
                 }
            </div>

            @if (analysisResult(); as result) {
                <div class="text-right bg-black/80 backdrop-blur-xl border border-purple-500/40 py-2 px-4 rounded-2xl">
                    <span class="text-xl font-black italic" [class]="getSignalClasses(result.signal)">{{ result.signal }}</span>
                </div>
            }
        </div>
    </main>

    <!-- COLUNA DIREITA: Comandos -->
    <aside class="col-span-12 lg:col-span-3 flex flex-col gap-4">
      @if (mode() === 'live') {
        <div class="bg-black/40 border border-purple-500/20 rounded-3xl p-6 flex flex-col items-center justify-center h-1/3">
            <span class="text-5xl font-black text-white font-mono tracking-tighter">{{ countdown() | number:'2.0-0' }}</span>
            <span class="text-[10px] text-purple-400 uppercase font-bold mt-2">Next Candle Sync</span>
        </div>
        
        @if (!isCapturing()) {
            <button (click)="connectToChart()" class="h-full bg-purple-600 hover:bg-purple-500 rounded-3xl font-black text-lg transition-all shadow-[0_0_25px_rgba(168,85,247,0.5)] active:scale-95">
                CONNECT SENSOR
            </button>
        } @else {
            <div class="h-2/3 flex flex-col gap-3">
                <button (click)="syncTimer()" [disabled]="isSynced()" class="flex-1 w-full bg-black/40 border border-green-500/50 text-green-400 font-bold rounded-3xl hover:bg-green-500/10 transition-all disabled:opacity-50">
                    {{ isSynced() ? 'TIMER SINCRONIZADO' : 'SINCRONIZAR VELA (M1)' }}
                </button>
                <div class="flex-1 grid grid-cols-2 gap-3">
                     <button (click)="forceScan()" [disabled]="isLoading()" class="h-full bg-purple-600/50 text-white font-bold rounded-3xl shadow-lg hover:opacity-80 disabled:opacity-50">
                        {{ isLoading() ? "..." : "SCAN" }}
                    </button>
                    <button (click)="disconnect()" class="h-full bg-red-500/20 text-red-400 border border-red-500/30 font-bold rounded-3xl">
                        STOP
                    </button>
                </div>
            </div>
        }
      } @else {
          <div class="h-full bg-black/40 border border-purple-500/20 rounded-3xl p-6 shadow-[0_0_20px_rgba(168,85,247,0.1)] flex flex-col justify-center">
            <h2 class="text-purple-400 font-bold text-xs mb-4 uppercase tracking-widest">Controles de Upload</h2>
             @if (uploadedImage()) {
                <div class="flex flex-col gap-3">
                    <button (click)="analyzeImage()" [disabled]="isLoading()" class="w-full text-center py-4 bg-purple-600 text-white font-bold rounded-2xl hover:bg-purple-500 disabled:bg-slate-600 transition-all">
                    {{ isLoading() ? "Analisando..." : "Analisar Imagem" }}
                    </button>
                    <button (click)="clearImage()" class="w-full text-center py-3 bg-white/5 text-slate-300 font-bold rounded-2xl hover:bg-white/10 transition-all">
                    Limpar
                    </button>
                </div>
             } @else {
                <p class="text-center text-sm text-gray-500">Selecione uma imagem no painel central para analisar.</p>
             }
          </div>
      }
    </aside>
  </main>

</div>
    